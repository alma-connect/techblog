<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
      <title>Alma Connect - Connecting you to your alma mater</title>
      <meta charset="utf-8">
      <link rel="icon" type="image/x-icon" href="/techblog/assets/img/fav.ico" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en-gb" />
      <meta name="description" content="AlmaConnect: connecting you to your alma mater | providing alumni network for your institute | Tech Blog">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700|Lora:400,700,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" type="text/css" href="/techblog/css/main.css" />
      <link rel="stylesheet" type="text/css" href="/techblog/css/syntax.css" />
      <link href="atom.xml" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=339489249409764";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <div id="off-canvas">
      <div id="avatar">
        <img src="/techblog/assets/img/logo2.png" alt="AlmaConnect" title="AlmaConnect">
      </div>
      <div id="bio">
          <h1>Hi, We'are AlmaConnect.</h1>
          <p>
            Alma Connect provides alumni platform for your institute. You can request and check for your college network: visit <a href="http://www.almaconnect.com/">www.almaconnect.com</a> now.
          </p>
      </div>
    </div>

    <header>
      <div class="h-wrap">
        <h1 class="title"><a href="/techblog" title="Back to Homepage">Alma Connect</a></h1>
        <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
      </div>
    </header>

    <main>
      <section id="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2014-03-18T06:00:00Z" itemprop="datePublished">
          18 March 2014
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">Implementing PUB/SUB in Rails; using ActiveSupport::Notifications</h1>
    <div itemprop="articleBody">
      <p>This artcile is about implmenting a simple publisher/subscriber model in rails using <a href="http://api.rubyonrails.org/classes/ActiveSupport/Notifications.html">ActiveSupport::Notifications</a> (ASN). Exploring problem areas where PUBSUB can improve modularity and reduce coupling. We would also upgrade our basic implementation to cater to common use cases.</p>

<ul>
<li><a href="#about-pub-sub">A little about PUB/SUB?</a></li>
<li><a href="#basic-implementation">Implementing basic publisher &amp; subscriber; lets get it on</a>

<ul>
<li><a href="#basic-publisher">Publisher</a></li>
<li><a href="#basic-subscriber">Subscriber</a></li>
</ul>
</li>
<li><a href="#use-cases">Use cases where PUB/SUB can be helpful</a>

<ul>
<li><a href="#problem-mail-delivery-coupling">Mail deliveries coupled with code</a></li>
<li><a href="#problem-callbacks-in-denormalized-models">Messy callback chain introduced due to denormalization</a></li>
<li><a href="#problem-handling-special-events">Handling of events like user milestone reached, batchmate signed up</a></li>
</ul>
</li>
<li><a href="#concluding-thoughts">Cocluding thoughts</a></li>
</ul>


<h1><a name="about-pub-sub">A little about PUB/SUB?</a></h1>

<p>According to <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">wikipedia</a> is:</p>

<blockquote><p>In software architecture, publishâ€“subscribe is a messaging pattern where senders of messages, called publishers, do not program the messages to be sent directly to specific receivers, called subscribers. Instead, published messages are characterized into classes, without knowledge of what, if any, subscribers there may be. Similarly, subscribers express interest in one or more classes, and only receive messages that are of interest, without knowledge of what, if any, publishers there are.</p></blockquote>

<p>Rails is a good framework for proof-of-concept and small applications, it promotes conventions over configuration. As the application grows it becomes difficult to maintain. This is primarily because rails promotes coupeled architecture with fat model, skinny controller approach. Developers need to adopt to new patterns and create new conventions to keep projects moving on pace and in shape. PUBSUB can help us resolve some of the problems we face often.</p>

<h1><a name="basic-implementation">Implementing basic publisher &amp; subscriber; lets get it on</a></h1>

<p>Baisc requirements of our PUBSUB are:</p>

<ol>
<li> Publishers should be able to publish named events with payload</li>
<li> Subscribers should be able to subscribe to events matching a name and should receive the payload object with every event</li>
</ol>


<p>Such a system is already bundled with rails: its <a href="http://api.rubyonrails.org/classes/ActiveSupport/Notifications.html">ActiveSupport::Notifications</a>(ASN). ASN is used through out rails internally for instrumentation. The basic implementation of ASN is such a simple yet powerful API that we can start our PUBSUB implementation on top of it.</p>

<h2><a name="basic-publisher">Publisher</a></h2>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/publisher.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Publisher</span>
<span class="lineno"> 3</span>   <span class="kp">extend</span> <span class="nb">self</span>
<span class="lineno"> 4</span>  
<span class="lineno"> 5</span>   <span class="k">def</span> <span class="nf">broadcast_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno"> 6</span>     <span class="k">if</span> <span class="nb">block_given?</span>
<span class="lineno"> 7</span>       <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">do</span>
<span class="lineno"> 8</span>         <span class="k">yield</span>
<span class="lineno"> 9</span>       <span class="k">end</span>
<span class="lineno">10</span>     <span class="k">else</span>
<span class="lineno">11</span>       <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="lineno">12</span>     <span class="k">end</span>
<span class="lineno">13</span>   <span class="k">end</span>
<span class="lineno">14</span> <span class="k">end</span>
</code></pre></div>




<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># publisher example usage</span>
<span class="lineno"> 2</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span> 
<span class="lineno"> 3</span>   <span class="no">Publisher</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="s1">&#39;user.created&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
<span class="lineno"> 4</span> <span class="k">end</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="lineno"> 7</span>   <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="lineno"> 8</span>   
<span class="lineno"> 9</span>   <span class="no">Publisher</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="s1">&#39;user.created&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span> <span class="k">do</span> 
<span class="lineno">10</span>     <span class="no">User</span><span class="o">.</span><span class="n">save!</span>
<span class="lineno">11</span>     <span class="c1"># do some more important stuff here</span>
<span class="lineno">12</span>   <span class="k">end</span>
<span class="lineno">13</span> <span class="k">end</span>
</code></pre></div>


<p>This is as simple as it gets. Publisher can broadcast an event accepting an event name and a payload hash. It can accept an optional block and will report the time taken to execute the block and also any error during execution of block (this is all provided by ASN used as base, interesting!!).</p>

<h2><a name="basic-subscriber">Subscriber</a></h2>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/subscriber.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Subscriber</span>
<span class="lineno"> 3</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
<span class="lineno"> 4</span>     <span class="k">if</span> <span class="nb">block_given?</span>
<span class="lineno"> 5</span>       <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
<span class="lineno"> 6</span>         <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="lineno"> 7</span>         <span class="k">yield</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno"> 8</span>       <span class="k">end</span>
<span class="lineno"> 9</span>     <span class="k">end</span>
<span class="lineno">10</span>   <span class="k">end</span>
<span class="lineno">11</span> <span class="k">end</span>
</code></pre></div>




<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="c1"># subscriber example usage</span>
<span class="lineno">2</span> <span class="no">Subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;user.created&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
<span class="lineno">3</span>   <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:exception</span><span class="o">].</span><span class="n">first</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:exception</span><span class="o">]</span>
<span class="lineno">4</span>   <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:user</span><span class="o">].</span><span class="n">id</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">5</span> <span class="k">end</span>
</code></pre></div>


<p>This is also pretty straight forward, to subscribe to an event just register with a name and the <a href="http://api.rubyonrails.org/classes/ActiveSupport/Notifications/Event.html">ActiveSupport::Notifications::Event</a> object gets passed to the attached block as the parameter.</p>

<h1><a name="use-cases">Use cases where PUB/SUB can be helpful</a></h1>

<p>These are some problems we face in our routine work, which can be solved by PUBSUB:</p>

<ul>
<li><a href="#problem-mail-delivery-coupling">Mail deliveries coupled with code</a></li>
<li><a href="#problem-callbacks-in-denormalized-models">Messy callback chain introduced due to denormalization</a></li>
<li><a href="#problem-handling-special-events">Handling of events like user milestone reached, batchmate signed up</a></li>
</ul>


<h2><a name="problem-mail-delivery-coupling">Mail deliveries coupled with code</a></h2>

<p><strong>Problem:</strong> There are always some kind of notifications at work in any user centeric application. Generally it starts with <code>after_save</code> model callback and slowly moves out of there to a services layer. Lets explore, how can we handle welcome emails to newly registered user using PUBSUB.</p>

<p><strong>Solution:</strong> Since we are adding this pattern to our application, lets bake in the modularity in core usage.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/publisher.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Publisher</span>
<span class="lineno"> 3</span>   <span class="kp">extend</span> <span class="o">::</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<span class="lineno"> 4</span>   <span class="kp">extend</span> <span class="nb">self</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>   <span class="n">included</span> <span class="k">do</span>
<span class="lineno"> 7</span>     <span class="c1"># add support for namespace, one class - one namespace</span>
<span class="lineno"> 8</span>     <span class="n">class_attribute</span> <span class="ss">:pub_sub_namespace</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="nb">self</span><span class="o">.</span><span class="n">pub_sub_namespace</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="lineno">11</span>   <span class="k">end</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="k">def</span> <span class="nf">broadcast_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno">14</span>     <span class="k">if</span> <span class="nb">block_given?</span>
<span class="lineno">15</span>       <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span> <span class="k">do</span>
<span class="lineno">16</span>         <span class="k">yield</span>
<span class="lineno">17</span>       <span class="k">end</span>
<span class="lineno">18</span>     <span class="k">else</span>
<span class="lineno">19</span>       <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno">20</span>     <span class="k">end</span>
<span class="lineno">21</span>   <span class="k">end</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> 
<span class="lineno">24</span>   <span class="k">module</span> <span class="nn">ClassMethods</span>
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">broadcast_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno">26</span>       <span class="n">event_name</span> <span class="o">=</span> <span class="o">[</span><span class="n">pub_sub_namespace</span><span class="p">,</span> <span class="n">event_name</span><span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="lineno">27</span>       <span class="k">if</span> <span class="nb">block_given?</span>
<span class="lineno">28</span>         <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">do</span>
<span class="lineno">29</span>           <span class="k">yield</span>
<span class="lineno">30</span>         <span class="k">end</span>
<span class="lineno">31</span>       <span class="k">else</span>
<span class="lineno">32</span>         <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="lineno">33</span>       <span class="k">end</span>
<span class="lineno">34</span>     <span class="k">end</span>
<span class="lineno">35</span>   <span class="k">end</span>
<span class="lineno">36</span> 
<span class="lineno">37</span> <span class="k">end</span>
</code></pre></div>


<p>The publisher under went some changes. It can be included in a class and after setting a namespace, you are all set to publish events in that namespace. We are not sure yet who might be interested, but lets just start broascasting event <code>user_signed_up</code> in <code>registration</code> namespace.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/publishers/registration.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Publishers</span>
<span class="lineno"> 3</span>   <span class="k">class</span> <span class="nc">Registration</span>
<span class="lineno"> 4</span>     <span class="kp">include</span> <span class="no">Publisher</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="nb">self</span><span class="o">.</span><span class="n">pub_sub_namespace</span> <span class="o">=</span> <span class="s1">&#39;registration&#39;</span>
<span class="lineno"> 7</span>   <span class="k">end</span>
<span class="lineno"> 8</span> <span class="k">end</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="no">Publishers</span><span class="o">::</span><span class="no">Registration</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="s1">&#39;user_signed_up&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
</code></pre></div>


<p>That was easy, publishers look good. Lets add some object oriented love and some ruby magic to subscribers too.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/subscribers/base.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Subscribers</span>
<span class="lineno"> 3</span>   <span class="k">class</span> <span class="nc">Base</span>
<span class="lineno"> 4</span>     <span class="n">class_attribute</span> <span class="ss">:subscriptions_enabled</span>
<span class="lineno"> 5</span>     <span class="kp">attr_reader</span> <span class="ss">:namespace</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 8</span>       <span class="vi">@namespace</span> <span class="o">=</span> <span class="n">namespace</span>
<span class="lineno"> 9</span>     <span class="k">end</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attach_to</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno">13</span>       <span class="n">log_subscriber</span> <span class="o">=</span> <span class="kp">new</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno">14</span>       <span class="n">log_subscriber</span><span class="o">.</span><span class="n">public_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
<span class="lineno">15</span>         <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_subscriber</span><span class="p">)</span>
<span class="lineno">16</span>       <span class="k">end</span>
<span class="lineno">17</span>     <span class="k">end</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>     <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="lineno">20</span>       <span class="nb">method</span>  <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="lineno">21</span>       <span class="n">handler</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno">22</span>       <span class="n">handler</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
<span class="lineno">23</span>     <span class="k">end</span>
<span class="lineno">24</span>   <span class="k">end</span>
<span class="lineno">25</span> <span class="k">end</span>
</code></pre></div>


<p>We creeate a base class which subscribers can extend. Subscriber can then attach its method to events in a namespace. This seems to be the building block of highly modular application.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/subscribers/registration_mailer.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Subscribers</span>
<span class="lineno"> 3</span>   <span class="k">class</span> <span class="nc">RegistrationMailer</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Subscribers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno"> 4</span>     <span class="k">def</span> <span class="nf">user_signed_up</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno"> 5</span>       <span class="c1"># lets delay the delivery using delayed_job</span>
<span class="lineno"> 6</span>       <span class="no">RegistrationMailer</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="ss">priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">welcome_email</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
<span class="lineno"> 7</span>     <span class="k">end</span>
<span class="lineno"> 8</span>   <span class="k">end</span>
<span class="lineno"> 9</span> <span class="k">end</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="c1"># config/initializers/subscribers.rb</span>
<span class="lineno">12</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">RegistrationMailer</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="s1">&#39;registration&#39;</span><span class="p">)</span>
</code></pre></div>


<p>We have been broadcasting that event about user sign up, but nothing was really happening as a result. We created a subscriber to do something useful when the event is captured; send out that welcome email we have been talking about.</p>

<p>There is a gotcha though, building modular, losely coupeled system with message publishing has its own cons. Biggest being, the system is too loosely coupeled. If something stops working nothing goes wrong and it might take too long to identify it. However I believe that failures can happen anywhere and a system which fails with grace is more robust that one which fails completely. Its another layer which gets introduced while building scalable systems. <strong>Base Line:</strong> for me pros out weigh the cons</p>

<p><strong>Conclusion:</strong> With little modifications, our PUBSUB now supports namespaces (read features, modules, sub-systems, opportunities!!). Adding a layer on top of already useful <code>ActiveSupport::Notification</code> already feels good enough.</p>

<h2><a name="problem-callbacks-in-denormalized-models">Messy callback chain introduced due to denormalization</a></h2>

<p><strong>Problem:</strong> We use mongodb via mongoid and denormalize data to cut down on queries. Intially it was some callbacks and method ooverrides, which grew out to be modules and then a simple re-usable denormalization plugin. It fall backs to querying data from related model and also cache it for future use. This works like a cache fetch or calculate &amp; store strategy with remote document as origin and current document as cache store. The code looks something like:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/models/user.rb</span>
<span class="lineno"> 2</span> <span class="k">class</span> <span class="nc">User</span>
<span class="lineno"> 3</span>   <span class="kp">include</span> <span class="no">AlmaConnect</span><span class="o">::</span><span class="no">Denormalization</span>
<span class="lineno"> 4</span>   <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="lineno"> 5</span>   <span class="n">has_many</span> <span class="ss">:posts</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1"># this sets up a callback for when name changes,</span>
<span class="lineno"> 8</span>   <span class="c1"># it propagates changes to posts where user_id matches the user</span>
<span class="lineno"> 9</span>   <span class="n">denormalize_to</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno">10</span> <span class="k">end</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c1"># app/models/post.rb</span>
<span class="lineno">13</span> <span class="k">class</span> <span class="nc">Post</span>
<span class="lineno">14</span>   <span class="kp">include</span> <span class="no">AlmaConnect</span><span class="o">::</span><span class="no">Denormalization</span>
<span class="lineno">15</span>   <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>   <span class="c1"># this sets up a callback to update user_name when user_id changes</span>
<span class="lineno">18</span>   <span class="c1"># also fetch and set, user name from user if it is not already set, when accessed</span>
<span class="lineno">19</span>   <span class="n">denormalize_from</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno">20</span> <span class="k">end</span>
</code></pre></div>


<p>It has been working out very nicely, but it results in very coupled code. We define denormalization macros in the models. This makes all our models aware of what data they are denormalizing, where from and also what data they need to denormalize, where to. What if we need to denormalize user name to comment as well.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/models/comment.rb</span>
<span class="lineno"> 2</span> <span class="k">class</span> <span class="nc">Comment</span>
<span class="lineno"> 3</span>   <span class="kp">include</span> <span class="no">AlmaConnect</span><span class="o">::</span><span class="no">Denormalization</span>
<span class="lineno"> 4</span>   <span class="n">embedded_in</span> <span class="ss">:post</span>
<span class="lineno"> 5</span>   <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="kp">nil</span>
<span class="lineno"> 6</span>   <span class="n">denormalize_from</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno"> 7</span> <span class="k">end</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c1"># app/models/post.rb</span>
<span class="lineno">10</span> <span class="k">class</span> <span class="nc">Post</span>
<span class="lineno">11</span>   <span class="kp">include</span> <span class="no">AlmaConnect</span><span class="o">::</span><span class="no">Denormalization</span>
<span class="lineno">12</span>   <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="lineno">13</span>   <span class="n">embeds_many</span> <span class="ss">:commments</span>
<span class="lineno">14</span>   <span class="n">denormalize_from</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno">15</span> <span class="k">end</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c1"># app/models/user.rb</span>
<span class="lineno">18</span> <span class="k">class</span> <span class="nc">User</span>
<span class="lineno">19</span>   <span class="kp">include</span> <span class="no">AlmaConnect</span><span class="o">::</span><span class="no">Denormalization</span>
<span class="lineno">20</span>   <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="lineno">21</span>   <span class="n">has_many</span> <span class="ss">:posts</span>
<span class="lineno">22</span>   <span class="n">denormalize_to</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>   <span class="c1"># we don&#39;t define the relation here, still define the denormalization macro</span>
<span class="lineno">25</span>   <span class="n">denormalize_to</span> <span class="s1">&#39;post.comments&#39;</span><span class="p">,</span> <span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="lineno">26</span> <span class="k">end</span>
</code></pre></div>


<p>You see the problem, right?</p>

<p><strong>Solution:</strong> Instead of sprinkling denormalization macros all around, we can leave the from macros as is, they implement the falback logic which comes in very handy. We can replace to macros, with publishing change events. We would simply publish a message whenever a user name changes. We can capture it in a <code>before_save</code> callback and publish in a <code>after_save</code>. By publishing in <code>after_save</code> we ensure that user is persisted at time of publishing. We can change the publisher to hook directly into model callback chain.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">  1</span> <span class="c1"># app/pub_sub/publishers/base.rb</span>
<span class="lineno">  2</span> <span class="c1"># hook into model callback chain when a publisher is attached to a model </span>
<span class="lineno">  3</span> <span class="c1"># capture changes before_save and publish in after_save</span>
<span class="lineno">  4</span> <span class="c1"># start publishing created and destroyed events</span>
<span class="lineno">  5</span> <span class="k">module</span> <span class="nn">Publishers</span>
<span class="lineno">  6</span>   <span class="k">module</span> <span class="nn">Base</span>
<span class="lineno">  7</span>     <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<span class="lineno">  8</span> 
<span class="lineno">  9</span>     <span class="k">def</span> <span class="nf">pub_sub_notifications</span>
<span class="lineno"> 10</span>       <span class="vi">@pub_sub_notifications</span> <span class="o">||=</span> <span class="o">::</span><span class="no">Publishers</span><span class="o">::</span><span class="no">PubSubNotifications</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
<span class="lineno"> 11</span>     <span class="k">end</span>
<span class="lineno"> 12</span> 
<span class="lineno"> 13</span>     <span class="k">module</span> <span class="nn">ClassMethods</span>
<span class="lineno"> 14</span>       <span class="k">def</span> <span class="nf">attach_publisher</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">publisher_class</span><span class="p">)</span>
<span class="lineno"> 15</span>         <span class="n">after_initialize</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
<span class="lineno"> 16</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">attach_publisher</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">publisher_class</span><span class="p">)</span>
<span class="lineno"> 17</span>         <span class="k">end</span>
<span class="lineno"> 18</span> 
<span class="lineno"> 19</span>         <span class="n">before_save</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
<span class="lineno"> 20</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">prepare_created</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 21</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">prepare_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 22</span>         <span class="k">end</span>
<span class="lineno"> 23</span> 
<span class="lineno"> 24</span>         <span class="n">after_save</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
<span class="lineno"> 25</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">publish_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 26</span>         <span class="k">end</span>
<span class="lineno"> 27</span> 
<span class="lineno"> 28</span>         <span class="n">after_destroy</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
<span class="lineno"> 29</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">prepare_destroyed</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 30</span>           <span class="n">model</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">publish_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 31</span>         <span class="k">end</span>
<span class="lineno"> 32</span>       <span class="k">end</span>
<span class="lineno"> 33</span>     <span class="k">end</span>
<span class="lineno"> 34</span> 
<span class="lineno"> 35</span>   <span class="k">end</span>
<span class="lineno"> 36</span> <span class="k">end</span>
<span class="lineno"> 37</span> 
<span class="lineno"> 38</span> <span class="c1"># app/pub_sub/publishers/notifications_queue.rb</span>
<span class="lineno"> 39</span> <span class="c1"># capture attachment of a publisher to a model in a namespace</span>
<span class="lineno"> 40</span> <span class="k">module</span> <span class="nn">Publishers</span>
<span class="lineno"> 41</span>   <span class="k">class</span> <span class="nc">NotificationsQueue</span>
<span class="lineno"> 42</span>     <span class="kp">attr_reader</span> <span class="ss">:publisher</span><span class="p">,</span> <span class="ss">:notifications</span>
<span class="lineno"> 43</span> 
<span class="lineno"> 44</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">publisher_name</span><span class="p">)</span>
<span class="lineno"> 45</span>       <span class="vi">@publisher</span> <span class="o">=</span> <span class="n">publisher_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">new</span>
<span class="lineno"> 46</span>       <span class="vi">@notifications</span> <span class="o">=</span> <span class="o">[]</span>
<span class="lineno"> 47</span>     <span class="k">end</span>
<span class="lineno"> 48</span> 
<span class="lineno"> 49</span>     <span class="k">def</span> <span class="nf">add_notification</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno"> 50</span>       <span class="vi">@notifications</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">event_name</span><span class="p">:</span> <span class="n">event_name</span><span class="p">,</span> <span class="ss">payload</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
<span class="lineno"> 51</span>     <span class="k">end</span>
<span class="lineno"> 52</span> 
<span class="lineno"> 53</span>     <span class="k">def</span> <span class="nf">reset_notifications</span>
<span class="lineno"> 54</span>       <span class="vi">@notifications</span> <span class="o">=</span> <span class="o">[]</span>
<span class="lineno"> 55</span>     <span class="k">end</span>
<span class="lineno"> 56</span>   <span class="k">end</span>
<span class="lineno"> 57</span> <span class="k">end</span>
<span class="lineno"> 58</span> 
<span class="lineno"> 59</span> <span class="c1"># app/pub_sub/publishers/pub_sub_notifications.rb</span>
<span class="lineno"> 60</span> <span class="c1"># handle different attachments of publishers to a model</span>
<span class="lineno"> 61</span> <span class="k">module</span> <span class="nn">Publishers</span>
<span class="lineno"> 62</span>   <span class="k">class</span> <span class="nc">PubSubNotifications</span>
<span class="lineno"> 63</span>     <span class="kp">include</span> <span class="o">::</span><span class="no">Publisher</span>
<span class="lineno"> 64</span> 
<span class="lineno"> 65</span>     <span class="kp">attr_reader</span> <span class="ss">:publishers_info</span><span class="p">,</span> <span class="ss">:model</span>
<span class="lineno"> 66</span> 
<span class="lineno"> 67</span>     <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="lineno"> 68</span>       <span class="vi">@publishers_info</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno"> 69</span>       <span class="vi">@model</span>               <span class="o">=</span> <span class="n">model</span>
<span class="lineno"> 70</span>     <span class="k">end</span>
<span class="lineno"> 71</span> 
<span class="lineno"> 72</span>     <span class="k">def</span> <span class="nf">attach_publisher</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">publisher_name</span><span class="p">)</span>
<span class="lineno"> 73</span>       <span class="n">publishers_info</span><span class="o">[</span><span class="n">namespace</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Publishers</span><span class="o">::</span><span class="no">NotificationsQueue</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">publisher_name</span><span class="p">)</span>
<span class="lineno"> 74</span>       <span class="kp">true</span>
<span class="lineno"> 75</span>     <span class="k">end</span>
<span class="lineno"> 76</span> 
<span class="lineno"> 77</span>     <span class="k">def</span> <span class="nf">reset_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 78</span>       <span class="n">publishers_info</span><span class="o">[</span><span class="n">namespace</span><span class="o">].</span><span class="n">reset_notifications</span>
<span class="lineno"> 79</span>     <span class="k">end</span>
<span class="lineno"> 80</span> 
<span class="lineno"> 81</span>     <span class="k">def</span> <span class="nf">add_notification</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno"> 82</span>       <span class="n">publishers_info</span><span class="o">[</span><span class="n">namespace</span><span class="o">].</span><span class="n">add_notification</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="lineno"> 83</span>     <span class="k">end</span>
<span class="lineno"> 84</span> 
<span class="lineno"> 85</span>     <span class="k">def</span> <span class="nf">prepare_created</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 86</span>       <span class="n">add_notification</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">new_record?</span>
<span class="lineno"> 87</span>     <span class="k">end</span>
<span class="lineno"> 88</span> 
<span class="lineno"> 89</span>     <span class="k">def</span> <span class="nf">prepare_destroyed</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 90</span>       <span class="n">add_notification</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">destroyed?</span>
<span class="lineno"> 91</span>     <span class="k">end</span>
<span class="lineno"> 92</span> 
<span class="lineno"> 93</span>     <span class="k">def</span> <span class="nf">prepare_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno"> 94</span>       <span class="n">publishers_info</span><span class="o">[</span><span class="n">namespace</span><span class="o">].</span><span class="n">publisher</span><span class="o">.</span><span class="n">prepare_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="lineno"> 95</span> 
<span class="lineno"> 96</span>       <span class="k">return</span> <span class="kp">true</span>
<span class="lineno"> 97</span>     <span class="k">end</span>
<span class="lineno"> 98</span> 
<span class="lineno"> 99</span>     <span class="k">def</span> <span class="nf">publish_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
<span class="lineno">100</span>       <span class="n">publishers_info</span><span class="o">[</span><span class="n">namespace</span><span class="o">].</span><span class="n">notifications</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">notification</span><span class="o">|</span>
<span class="lineno">101</span>         <span class="n">broadcast_event</span><span class="p">(</span>
<span class="lineno">102</span>             <span class="o">[</span><span class="n">namespace</span><span class="p">,</span> <span class="n">notification</span><span class="o">[</span><span class="ss">:event_name</span><span class="o">]].</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span>
<span class="lineno">103</span>             <span class="n">notification</span><span class="o">[</span><span class="ss">:payload</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="ss">model</span><span class="p">:</span> <span class="n">model</span><span class="p">)</span>
<span class="lineno">104</span>         <span class="p">)</span>
<span class="lineno">105</span>       <span class="k">end</span>
<span class="lineno">106</span> 
<span class="lineno">107</span>       <span class="k">return</span> <span class="kp">true</span>
<span class="lineno">108</span>     <span class="k">end</span>
<span class="lineno">109</span> 
<span class="lineno">110</span>   <span class="k">end</span>
<span class="lineno">111</span> <span class="k">end</span>
</code></pre></div>


<p>We created a module, which can be included in any active model complaint model, supporting callbacks. Model can attash publishers to itself against a namespace. Attached publisher immediately starts broadcasting created and destroyed for the model. To broadcast additional events, publisher should override the <code>prepare_notifications</code> method and make calls to <code>model.pub_sub_notifications.add_notification</code>.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/publishers/user.rb</span>
<span class="lineno"> 2</span> <span class="k">module</span> <span class="nn">Publishers</span>
<span class="lineno"> 3</span>   <span class="k">module</span> <span class="nn">User</span>
<span class="lineno"> 4</span>     <span class="k">def</span> <span class="nf">prepare_notifications</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
<span class="lineno"> 5</span>       <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">name_changed?</span>
<span class="lineno"> 6</span>         <span class="n">user</span><span class="o">.</span><span class="n">pub_sub_notifications</span><span class="o">.</span><span class="n">add_notification</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;name_changed&#39;</span><span class="p">,</span> <span class="ss">changes</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name_changes</span><span class="p">)</span>
<span class="lineno"> 7</span>       <span class="k">end</span>
<span class="lineno"> 8</span>     <span class="k">end</span>
<span class="lineno"> 9</span>   <span class="k">end</span>
<span class="lineno">10</span> <span class="k">end</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c1"># app/models/user.rb</span>
<span class="lineno">13</span> <span class="k">class</span> <span class="nc">User</span>
<span class="lineno">14</span>   <span class="kp">include</span> <span class="no">Publishers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>   <span class="n">attach_publisher</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="no">Publishers</span><span class="o">::</span><span class="no">User</span><span class="p">)</span>
<span class="lineno">17</span> <span class="k">end</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="k">class</span> <span class="nc">Subscribers</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Post</span> <span class="o">&lt;</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno">20</span>   <span class="k">def</span> <span class="nf">name_changed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno">21</span>     <span class="no">Post</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:model</span><span class="o">].</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="n">user_name</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:changes</span><span class="o">].</span><span class="n">last</span><span class="p">)</span>
<span class="lineno">22</span>   <span class="k">end</span>
<span class="lineno">23</span> <span class="k">end</span>
<span class="lineno">24</span> 
<span class="lineno">25</span> <span class="k">class</span> <span class="nc">Subscribers</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Comment</span> <span class="o">&lt;</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno">26</span>   <span class="k">def</span> <span class="nf">name_changed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno">27</span>     <span class="k">def</span> <span class="nf">name_changed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno">28</span>       <span class="n">iteration_limit</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># or fetch max comment count</span>
<span class="lineno">29</span>       <span class="n">posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:comments</span><span class="o">.</span><span class="n">matches</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">user_id</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:model</span><span class="o">].</span><span class="n">id</span><span class="p">,</span> <span class="ss">:user_name</span><span class="o">.</span><span class="n">ne</span> <span class="o">=&gt;</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:changes</span><span class="o">].</span><span class="n">last</span><span class="p">})</span>
<span class="lineno">30</span>       <span class="k">while</span> <span class="n">iteration_limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">posts</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="lineno">31</span>         <span class="no">Post</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">selector</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$set&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;comments.$.user_name&#39;</span> <span class="o">=&gt;</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:changes</span><span class="o">].</span><span class="n">last</span><span class="p">}</span> <span class="p">},</span> <span class="ss">multi</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">safe</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="lineno">32</span>       <span class="k">end</span>
<span class="lineno">33</span>     <span class="k">end</span>
<span class="lineno">34</span>   <span class="k">end</span>
<span class="lineno">35</span> <span class="k">end</span>
<span class="lineno">36</span> 
<span class="lineno">37</span> <span class="c1"># config/initializers/subscribers.rb</span>
<span class="lineno">38</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Post</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="lineno">39</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Comment</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</code></pre></div>


<p>This is a lot more code, but this system seems robust:</p>

<ul>
<li>Easy to add new denormalization points</li>
<li>Complete control of how to handle the change</li>
<li>A lot more modular system</li>
<li>Easily take out some subscriber or publisher without affecting the system</li>
<li>Individual sub-components can be enabled, disabled and changed independently</li>
</ul>


<p><strong>Conclusion:</strong> Adding some more ruby goodness to the mix, we have built a production grade iron to straighten out the callback spaghetti we have been cooking recently.</p>

<h2><a name="problem-handling-special-events">Handling of events like user milestone reached, batchmate signed up</a></h2>

<p><strong>Problem:</strong> A user signs up, this can potentially trigger a user milestone and would most probably trigger batchamted signed up notification. Where do we keep this code? In the service concerned with creation of user? In model callback? Nothing seems to fit the bill.</p>

<p><strong>Solution:</strong> Lucky for us, we already have our PUBSUB. We can listen to <code>user.created</code> event from our user publisher and trigger approriate behaviour in a subscriber. Sending welcome mail and batchmate activity is not core to the application and should not effect core if smtp is not working at the moment.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/services/registration/user_notifications_service.rb</span>
<span class="lineno"> 2</span> <span class="k">class</span> <span class="nc">Registration</span><span class="o">::</span><span class="no">UserNotificationsService</span>
<span class="lineno"> 3</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver_welcome_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno"> 4</span>     <span class="no">RegistrationMailer</span><span class="o">.</span><span class="n">welcome</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
<span class="lineno"> 5</span>   <span class="k">end</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">prepare_batchmate_notification</span><span class="p">(</span><span class="n">batchmate</span><span class="p">)</span>
<span class="lineno"> 8</span>     <span class="no">User</span><span class="o">.</span><span class="n">batchmates_of</span><span class="p">(</span><span class="n">batchmate</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
<span class="lineno"> 9</span>       <span class="no">Publishers</span><span class="o">::</span><span class="no">Registration</span><span class="o">.</span><span class="n">broadcast_event</span><span class="p">(</span><span class="s1">&#39;deliver_batchmate_signed_up&#39;</span><span class="p">,</span> <span class="ss">batchmate</span><span class="p">:</span> <span class="n">batchmate</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
<span class="lineno">10</span>     <span class="k">end</span>
<span class="lineno">11</span>   <span class="k">end</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver_batchmate_signed_up_email</span><span class="p">(</span><span class="n">batchmate</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
<span class="lineno">14</span>     <span class="no">RegistrationMailer</span><span class="o">.</span><span class="n">batchmate_signed_up</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">batchmate</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
<span class="lineno">15</span>   <span class="k">end</span>
<span class="lineno">16</span> <span class="k">end</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="c1"># app/jobs/welcome_email_job.rb</span>
<span class="lineno">19</span> <span class="k">class</span> <span class="nc">WelcomeEmailJob</span>
<span class="lineno">20</span>   <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno">21</span>     <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
<span class="lineno">22</span>   <span class="k">end</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>   <span class="k">def</span> <span class="nf">perform</span>
<span class="lineno">25</span>     <span class="no">Registration</span><span class="o">::</span><span class="no">UserNotificationsService</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno">26</span>   <span class="k">end</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno">29</span>     <span class="no">Delayed</span><span class="o">::</span><span class="no">Job</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="kp">new</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
<span class="lineno">30</span>   <span class="k">end</span>
<span class="lineno">31</span> <span class="k">end</span>
<span class="lineno">32</span> 
<span class="lineno">33</span> <span class="c1"># app/jobs/batchmate_activity_job.rb</span>
<span class="lineno">34</span> <span class="k">class</span> <span class="nc">BatchmateActivityJob</span>
<span class="lineno">35</span>   <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">batchmate</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
<span class="lineno">36</span>     <span class="vi">@batchmate</span> <span class="o">=</span> <span class="vi">@batchmate</span>
<span class="lineno">37</span>     <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
<span class="lineno">38</span>   <span class="k">end</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>   <span class="k">def</span> <span class="nf">perform</span>
<span class="lineno">41</span>     <span class="k">if</span> <span class="n">bundled?</span>
<span class="lineno">42</span>       <span class="no">Registration</span><span class="o">::</span><span class="no">UserNotificationsService</span><span class="o">.</span><span class="n">prepare_batchmate_notification</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="vi">@batchmate</span><span class="p">)</span>
<span class="lineno">43</span>     <span class="k">else</span>
<span class="lineno">44</span>       <span class="no">Registration</span><span class="o">::</span><span class="no">UserNotificationsService</span><span class="o">.</span><span class="n">deliver_batchmate_signed_up_email</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="vi">@batchmate</span><span class="p">)</span>
<span class="lineno">45</span>     <span class="k">end</span>
<span class="lineno">46</span>   <span class="k">end</span>
<span class="lineno">47</span> 
<span class="lineno">48</span>   <span class="k">def</span> <span class="nf">bundled?</span>
<span class="lineno">49</span>     <span class="vi">@user</span><span class="o">.</span><span class="n">nil?</span>
<span class="lineno">50</span>   <span class="k">end</span>
<span class="lineno">51</span> 
<span class="lineno">52</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">prepare</span><span class="p">(</span><span class="n">batchmate</span><span class="p">)</span>
<span class="lineno">53</span>     <span class="no">Delayed</span><span class="o">::</span><span class="no">Job</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="kp">new</span><span class="p">(</span><span class="n">batchmate</span><span class="p">))</span>
<span class="lineno">54</span>   <span class="k">end</span>
<span class="lineno">55</span> 
<span class="lineno">56</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver</span><span class="p">(</span><span class="n">batchmate</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
<span class="lineno">57</span>     <span class="no">Delayed</span><span class="o">::</span><span class="no">Job</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="kp">new</span><span class="p">(</span><span class="n">batchmate</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
<span class="lineno">58</span>   <span class="k">end</span>
<span class="lineno">59</span> <span class="k">end</span>
</code></pre></div>


<p>Till now we have created everything we need to send out welcome email and milestone notification. We can see that the jobs expose three methods and they correspond to three methods in our notification service. Notification service is the place where all the real action is going on, all the business logic lives there. Notification service methods should be delayed, so we have created two jobs, each handling delaying of welcome emails and milesonte notification. We can now write the subscribers and and wire everything up.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># app/pub_sub/subscribers/registration/user.rb</span>
<span class="lineno"> 2</span> <span class="k">class</span> <span class="nc">Subscribers</span><span class="o">::</span><span class="no">Registration</span><span class="o">::</span><span class="no">User</span> <span class="o">&lt;</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno"> 3</span>   <span class="k">def</span> <span class="nf">created</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno"> 4</span>     <span class="no">WelcomeEmailJob</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno"> 5</span>     <span class="no">BatchmateActivityJob</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="lineno"> 6</span>   <span class="k">end</span>
<span class="lineno"> 7</span> <span class="k">end</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="k">module</span> <span class="nn">Subscribers</span>
<span class="lineno">10</span>   <span class="k">class</span> <span class="nc">RegistrationMailer</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Subscribers</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno">11</span>     <span class="k">def</span> <span class="nf">deliver_batchmate_signed_up</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<span class="lineno">12</span>       <span class="no">BatchmateActivityJob</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:batchmate</span><span class="o">]</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
<span class="lineno">13</span>     <span class="k">end</span>
<span class="lineno">14</span>   <span class="k">end</span>
<span class="lineno">15</span> <span class="k">end</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c1"># config/initializers/subscribers.rb</span>
<span class="lineno">18</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">Registration</span><span class="o">::</span><span class="no">User</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="lineno">19</span> <span class="no">Subscribers</span><span class="o">::</span><span class="no">RegistrationMailer</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="s1">&#39;registration&#39;</span><span class="p">)</span>
</code></pre></div>


<p><strong>Conclusion:</strong> This wires everything up. Cool isn't it. We have built a modular and composable system. We gain a lot of flexibility and get a change to phase out some bad code.</p>

<h1><a name="concluding-thoughts">Cocluding thoughts</a></h1>

<p>A simple pattern like pub/sub can help us write highly decoupled modules. These loosely coupeled modules can be composed together in variety of ways to create a flexible, robust and scalable application. The modules can be replaced and upgraded without affecting the system as whole.</p>

<p>If you liked today's article, keep looking for the next one. If you like the implmentation and would love to help in gemifying it, please get in touch at <code>rubish[dot]gupta[at]almaconnect[dot]com</code> or <code>tech[dot]team[at]almaconnect[dot]com</code></p>

    </div>

    <div id="share" class="feat">
      <!-- AddThis Button BEGIN -->
      <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
      <a class="addthis_button_preferred_1"></a>
      <a class="addthis_button_preferred_2"></a>
      <a class="addthis_button_preferred_3"></a>
      <a class="addthis_button_preferred_4"></a>
      <a class="addthis_button_compact"></a>
      <a class="addthis_counter addthis_bubble_style"></a>
      </div>
      <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
      <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-532791d823f554dc"></script>
      <!-- AddThis Button END -->
    </div>

    <div class="facebook-comments">
      <div class="fb-comments" data-href="http://alma-connect.github.io/techblog/2014/03/rails-pub-sub.html" data-numposts="5" data-colorscheme="light"></div>
    </div>

    
    
  </article>
</section>

    </main>

    <footer>
      <small>
      Powered by Jekyll - Theme: <a href="https://github.com/m3xm/hikari-for-Jekyll">hikari</a> - &copy; AlmaConnect
      </small>
    </footer>

    <script src="/techblog/js/main.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-49058929-1', 'almaconnect.com');
        ga('send', 'pageview');
      </script>
    

  </body>
</html>
